{% extends "base.html" %} {% block main %}
<div class="full-background letsgo">
	<!-- <img class="rest-image" src="/static/images/home_background.png"/> -->

	<div class="loading"></div>
	
	<div class="top-bar">
		<div class="bar-background"></div>
		<div class="menu-button">
			<button class="img-btn"></button>
			<div class="user-menu-small">
				<div class="user-picture"></div>
				<div class="text-300 user-name">Welcome <br/> {{user.first_name}}</div>
			</div>
		</div>
		<div class="logo"></div>
	</div>
	
	<div class="rest-details">
		<button class="img-btn prev"></button>
		<div class="main">
			<p class="text-100 red-text center-text first">In this picture</p>
			<p class="text-100 red-text name">Restaurant name</p>
			<p class="text-100 red-text address">address</p>
			<p class="text-100 red-text distance">Distance: 100 m</p>
		</div>
		<button class="img-btn next"></button>
	</div>
	
	<div class="left-menu scrollable">
		<div class="user-menu">
			<div class="user-picture"></div>
			<h2 class="text-300 user-name">Welcome {{user.first_name}}</h2>
		</div>
		<br/>
		
		<ul class="menu-items">
			<li><button class="img-btn" id="rate-more">Rate more places</button></li>
			<li><button class="img-btn selected" id="near-me">Near me</button></li>
			<li><button class="img-btn" id="discounts">Discounts</button></li>
			<li><button class="img-btn" id="inspire-me">Inspire me</button></li>
			<li><button class="img-btn" id="settings">Search settings</button></li>
			<li><button class="img-btn" id="logout">Log out</button></li>
		</ul>
	
	</div>

</div>

<div class="popup-area"></div>




<!-- <ul id="places">

	{% if not list %}
	<p>Loading...</p>
	{% endif %}
	
	{% for rest in list %}
	<li>

		<div>
			<p>{{rest.name}}</p>
			<p>{{rest.address.street}}, {{rest.address.city}}</p>
		</div>
		<ul>
			{% for rating in rest.ratings %}
			<li>User {{rating.user.id()}} rated {{rating.value}} for purpose
				{{rating.purpose}}</li> {% endfor %}
		</ul>

	</li> {% endfor %}
</ul> -->



{% endblock %} {% block scripts %}

<script type="text/javascript">
$(window).load(function() {
	if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(showRecommendations);
    } else { 
        alert("Geolocation is not supported by this browser.");
    }
	
	var places = [];
	var pos = 0;
	
	function renderPlace(pos){
		if(window.console){
			console.log("Showing place " + pos + " of " + places.length);
		}
		//enable prev and next buttons
		$('.rest-details .prev').removeClass('disabled');
		$('.rest-details .next').removeClass('disabled');
		if(pos >= places.length-1){
			//disable next button
			$('.rest-details .next').addClass('disabled');
		}
		if(pos == 0){
			//disable prev button
			$('.rest-details .prev').addClass('disabled');
		}
		
		var p = places[pos];
		$('.rest-details .name').html(p.name);
		$('.rest-details .address').html(p.address.street + ', ' + p.address.city);
		if(p.distance){
			
			var meters = Math.round(p.distance);
			var text = 'Distance: '
			if(meters < 1000){
				text += meters + ' m';
			} else {
				km = meters / 1000;
				text += km.toFixed(2) + ' km';
			}
			$('.rest-details .distance').html(text);
			$('.rest-details .distance').show();
		} else {
			$('.rest-details .distance').hide();
		}
		
		var picture = p.picture;
		if(picture == undefined || picture == '' || picture == 'null'){
			picture = '/static/images/empty_big.png';
		}
		$('.letsgo').css('background-image', 'url(' + picture + ')');
	}
	
	function onNext(){
		if(pos < places.length-1){
			pos += 1;
			renderPlace(pos);
		} else {
			//there are no more places after the one already shown
			//do nothing
		}
	}
	
	function onPrev(){
		if(pos > 0 ){
			pos -= 1;
			renderPlace(pos);
		} else {
			//there are no places before the one already shown
			//do nothing
		}
	}
	
	$('.rest-details .next').click(onNext);
	$('.rest-details .prev').click(onPrev);
	
	function showRecommendations(position) {
		var user = {{user|safe}};
		var settings =user.settings; 
		if(settings == undefined){
			settings = {purpose: 'dinner with tourists', max_distance: 1000, num_places: 5};
		} else {
			if (settings.purpose == undefined){
				settings.purpose = 'dinner with tourists';
			}
			if (settings.max_distance == undefined){
				settings.max_distance = 1000;
			}
			if(settings.num_places == undefined){
				settings.num_places = 5
			}
		}
		
		
		url = '/recommender/?lat=' + position.coords.latitude + '&lon=' + position.coords.longitude + 
				'&max_dist='+ settings.max_distance+'&purpose=' + settings.purpose + '&n=' + settings.num_places;
	    $.ajax({
			type : 'GET',
			url : url,
			success : function(data) {
				$('.loading').hide();
				places = data;
				
				if(places == null || places.length < 1){
					alert('We are sorry, we found no places around your current position.');
				}
				
				renderPlace(pos);
					
				/* places_str = '';
				for(var i=0; i< places.length; i++){
					p = places[i];
					places_str += '<li><div><p>' + p.name + '</p><p>'+ p.address.street + ', ' + p.address.city + '</p></div></li>';
				}
				$('#places').html(places_str);  */
			},
			error : function(resp) {
				console.log(resp);
				alert("Error " + resp.status);
			}
		}); 
	}
	
	
	
	
	$('.left-menu').hide();
	var count = 1;
	$('.menu-button button').click(function(){
		if(count % 2 == 1){
			//odd time --> open left menu
			$('.left-menu').show();
			$('.user-menu-small').hide();
			count++;
		} else {
			//even time --> close left menu
			$('.left-menu').hide();
			$('.user-menu-small').show();
			count++;
		}
		
	});
	
	$('.scrollable').enscroll({
	    showOnHover: false,
	    verticalScrolling: true,
		horizontalScrolling: false,
		zIndex: 100,
	    verticalTrackClass: 'track-white',
	    verticalHandleClass: 'handle-white'
	});
	
	
	var userpic = String("{{user.picture if user.picture != None else ''}}");
	if(userpic != undefined && userpic.length > 0){	
		$('.user-picture').css('background-image', 'url(' + userpic + ')');
	}
	
	$('.user-menu, .user-menu-small').click(function(){
		window.location = '/profile/1';
	});
	
	$('#logout').click(function(){
		$.ajax({
			type : 'DELETE',
			url : '/api/user/login',
			success : function() {
				window.location = '/';
			},
			error : function(resp) {
				console.log(resp);
				alert("Error " + resp.status);
			}
		});
	});

	$('#discounts').click(function(){
		alert("Coming soon.")
	});
	
	$('#inspire-me').click(function(){
		alert("Coming soon.")
	});
	
	$('#settings').click(function(){
		
		// var settings ={{(user.settings|e) if user.settings is not none else 'undefined'}}; 
		var user = {{user|safe}};
		var settings =user.settings; 
		if(settings == undefined){
			settings = {purpose: 'dinner with tourists', max_distance: 1000, num_places: 5};
		}
		
		//load underscore template
		var xmlhttp = new XMLHttpRequest();
		xmlhttp.open("GET","/static/js_templates/settings_popup.ejs",false);
		xmlhttp.send(null);
		var template = xmlhttp.responseText;
		var compiled = _.template(template);
		var html = compiled({settings: settings});
		$('.popup-area').html(html);
		
		$('.popup-area').show();
		
		$('.popup-scrollable').enscroll({
		    showOnHover: false,
		    verticalScrolling: true,
			horizontalScrolling: false,
			zIndex: 320,
		    verticalTrackClass: 'track-red',
		    verticalHandleClass: 'handle-red'
		});
		
		$('.close-popup').click(function(){
			$('.popup-area').hide();
		})
	});
	
	
	
	
});
</script>

{% endblock %}
