{% extends "base.html" %} {% block main %}
<div class="full-background rest">
		<div class="top-bar rest-bar">
			<div class="bar-background"></div>
			<div class="menu-button">
				<button class="img-btn"></button>
				<div class="user-menu-small clickable">
					<div class="user-picture"></div>
					<div class="text-bold user-name">
						{{ lang['welcome']}}<br />{{user.first_name}}
					</div>
				</div>
			</div>
			<div class="rest-logo"></div>
		</div>
	
	<div class="left-menu scrollable">
		<div class="user-menu clickable">
			<div class="user-picture"></div>
			<h2 class="text-bold user-name">{{ lang['welcome']}}</h2>
		</div>
		<br/>
		
		<ul class="menu-items">
			<li><button class="img-btn" id="rate-more">{{ lang['rate_more']}}</button></li>
			<li><button class="img-btn" id="near-me">{{ lang['near_me']}}</button></li>
			<li><button class="img-btn" id="logout">{{ lang['log_out']}}</button></li>
		</ul>
	
	</div>
	
	<h3>Your coupons:</h3>
	
	<p>Active coupons: </p>
	<div id="current_available"></div>
	
	
	<p>Used coupons: </p>
	<div id="used"></div>
	
{% endblock %} {% block scripts %}

<script type="text/javascript">
$(window).ready(function() {
	var window_height = $('.rest').height();
	var bar_height = $('.top-bar').height();
	$('.rest-container.scrollable').height(window_height - bar_height - 40);
	
});
$(window).load(function() {
	
	function getCookie(cname) {
		var name = cname + "=";
		var ca = document.cookie.split(';');
		for (var i = 0; i < ca.length; i++) {
			var c = ca[i];
			while (c.charAt(0) == ' ')
				c = c.substring(1);
			if (c.indexOf(name) != -1)
				return c.substring(name.length, c.length);
		}
		return "";
	};
	
	var auth = getCookie('user');
	
	function loadDiscounts(){
		$.ajax({
			type : 'GET',
			url : '/api/discount?coupon_user={{user.key}}',
			success : function(data) {
				$('.loading').hide();
				discounts = data;
				
				avail_disc_list = [];
				used_coupons = [];
				
				if(discounts != undefined && discounts.length > 0){
					for(var i=0; i< discounts.length; i++){
						var d = discounts[i];
						if(window.console){
							console.log(JSON.stringify(d));
						}
						var coupon = null;
						if(d.coupons != undefined && d.coupons.length == 1){
							coupon = d.coupons[0];
						} else {
							// no coupon for this discount --> skip!
							continue;
						}
						
						if(Date.parse(d.end_time) < new Date() || coupon.used ){
							used_coupons.push(d);
							console.log('saved in used')
						} else {
							avail_disc_list.push(d);
							console.log('saved in avail')
						}
					}
				}
				
				if(window.console){
					console.log("Lists: " + avail_disc_list.length + ", " + used_coupons.length );
				}
				
				//load underscore template
				var xmlhttp = new XMLHttpRequest();
				xmlhttp.open("GET","/static/js_templates/coupon_list.ejs",false);
				xmlhttp.send(null);
				var template = xmlhttp.responseText;
				var compiled = _.template(template);
				
				if(avail_disc_list == null || avail_disc_list.length < 1){
					$('#current_available').html('<p>{{ lang['no_discounts']}}</p>');
				} else {
					var html = compiled({
						discounts : avail_disc_list, lang: '{{lang_name}}', strings: {{lang['discount_strings']|safe}}
					});
					$('#current_available').html(html);
				}
				
				if(used_coupons == null || used_coupons.length < 1){
					$('#used').html('<p>{{ lang['no_discounts']}}</p>');
				} else {
					var html = compiled({
						discounts : used_coupons, lang: '{{lang_name}}', strings: {{lang['discount_strings']|safe}}
					});
					$('#used').html(html);
				}
				
			},
			error : function(resp) {
				if(window.console){
					console.log(resp);
				}
				alert("Error " + resp.status);
			}
		}); 
	}
	
	loadDiscounts();
	
	$('.rest-container.scrollable').enscroll({
	    showOnHover: false,
	    verticalScrolling: true,
		horizontalScrolling: false,
		zIndex: 100,
	    verticalTrackClass: 'track-red',
	    verticalHandleClass: 'handle-red'
	});
	
	var userpic = "{{ user.picture if not user.picture is none }}";
	if(userpic != undefined && userpic.length > 0){	
		$('.user-picture').css('background-image', 'url(' + userpic + ')');
	}
	$('.left-menu').hide();
	var window_width = $('.rest').width();
	var count = 1;
	$('.menu-button button').click(function(){
		if(count % 2 == 1){
			//odd time --> open left menu
			$('.left-menu').show();
			if(window_width > 600){
				$('.user-menu-small').hide();
			}
			$('.left-menu.scrollable').enscroll({
			    showOnHover: false,
			    verticalScrolling: true,
				horizontalScrolling: false,
				zIndex: 100,
			    verticalTrackClass: 'track-white',
			    verticalHandleClass: 'handle-white'
			});
			count++;
		} else {
			//even time --> close left menu
			$('.left-menu').hide();
			// show user menu small if width larger than 600px
			if(window_width > 600){
				$('.user-menu-small').show();
			}
			count++;
		}
		
	});
	
	
	$('#rate-more').click(function(){
		window.location = '/ratings'
	});
	$('#near-me').click(function(){
		window.location = '/letsgo'
	});
	$('#logout').click(function(){
		$.ajax({
			type : 'DELETE',
			url : '/api/user/login',
			success : function() {
				window.location = '/';
			},
			error : function(resp) {
				if(window.console){
					console.log(resp);
				}
				alert("Error " + resp.status);
			}
		});
	});
	
	$('.user-menu, .user-menu-small').click(function(){
		window.location = '/profile/1';
	});
	
	
	
});
</script>

{% endblock %}